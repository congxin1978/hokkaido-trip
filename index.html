<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>北海道之旅 · 圖文行程（漫畫風 + 地圖 + 圖集）</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
<style>
:root{ --ink:#0a1424; --paper:#fffdf9; --ring:#00000026; --r:26px;
  --pink1:#ff8fb1; --pink2:#ffd1e6; --wxline:#cde0ff;
}
*{box-sizing:border-box} body{margin:0}
/* Header */
header{ position:sticky; top:0; z-index:10; background:linear-gradient(180deg,var(--pink1),var(--pink2));
  border-bottom:2px solid #ffd6e8; box-shadow:0 8px 18px #00000024; font-family:"Baloo 2","Zen Maru Gothic",ui-rounded,system-ui;
}
.bar{ max-width:1100px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:10px; justify-content:space-between }
h1{ margin:0; font-size:22px; letter-spacing:.3px; color:#4a1a2a; text-shadow:0 2px 0 #ffffffa8, 0 6px 16px #ff9ec244}
.lang{display:flex; gap:8px; align-items:center} .lang button{border:2px solid #ffe0ec;background:#fff;border-radius:12px;padding:6px 10px;box-shadow:0 6px 12px #00000012;font-weight:800}
.lang .on{background:#ffe8f2}
/* Home dark-warm */
body.home{ background:
  radial-gradient(1200px 800px at 10% -10%, #2a1a12 0%, #2e1c13 30%, #331f15 60%) no-repeat,
  linear-gradient(180deg,#3b2419 0%, #3a2317 40%, #42271a 100%);
  color:#f2e9e2; font-family:"Baloo 2","Zen Maru Gothic",ui-rounded,system-ui;
}
main{ max-width:1100px; margin:10px auto 100px; padding:0 12px; position:relative; z-index:1 }
.manga-bg{ position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.16;
  background: radial-gradient(300px 420px at 15% 65%, #000 0 60%, #0000 61%),
             radial-gradient(280px 360px at 82% 60%, #000 0 60%, #0000 61%),
             radial-gradient(220px 280px at 55% 80%, #000 0 60%, #0000 61%);
  mix-blend-mode:overlay;
}
/* Home widgets */
.homebar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:10px 0 14px}
.homebar .input{display:flex; align-items:center; gap:6px; border:1px solid #6da9ff; border-radius:12px; padding:6px 10px; background:#1f2b44; color:#dbe8ff}
.homebar input[type="date"]{background:transparent; color:#dbe8ff; border:0; outline:none}
.wx{margin:8px 0 12px; padding:10px; border:1px solid var(--wxline); border-radius:16px; background:#17325a;
  display:flex; flex-wrap:wrap; gap:8px; align-items:center; box-shadow:0 10px 18px #00000050; color:#e9f2ff}
.wx .t{font-weight:900} .wx small{color:#b9d1ff}
.wx .item{flex:1 1 160px; background:#0e2442; border:1px dashed #2b5aa8; border-radius:12px; padding:8px; color:#e9f2ff}
.wx .item b{font-size:12px; color:#bfd6ff}
.wx .v{font-size:18px; font-weight:800}
/* Buttons */
.grid{display:grid; grid-template-columns:1fr; gap:18px}
.btn{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:12px;
  text-decoration:none; color:#fff; padding:18px 16px; border-radius:28px;
  background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
  border:1px solid rgba(255,255,255,.28); backdrop-filter: blur(10px);
  box-shadow: 0 18px 26px -10px #00000070, inset 0 0 0 1px rgba(255,255,255,.25); font-weight:900; font-size:18px; overflow:hidden
}
.grid a:nth-child(odd){transform: translateX(8px) rotate(-1.2deg)} .grid a:nth-child(even){transform: translateX(-8px) rotate(1.2deg)}
.btn .left{display:flex;align-items:center;gap:12px} .emoji{font-size:24px; filter: drop-shadow(0 2px 2px #00000060)}
.chev{font-weight:900; width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
  background:rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.35); color:#fff; box-shadow:0 8px 16px #00000050}
.tag{font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.28); color:#ffeede}
/* Sections (detail) */
.section{display:none; margin-top:18px; color:#0b2240}
.section:target{display:block}
body.detail{ background:
  radial-gradient(1400px 700px at 10% -10%, #eaf4ff 0%, #f6fbff 36%, #ffffff 70%) no-repeat,
  linear-gradient(180deg,#eef8ff,#ffffff 26%, #ffffff 100%);
  color:#0b2240;
}
.hero{ position:relative; border-radius: var(--r); border:1px solid #dbe3f0; background:#fff; overflow:hidden;
  box-shadow:0 24px 36px var(--ring), inset 0 0 0 2px #ffffffd9, inset 0 18px 28px #ffffffb8;
}
.hero .inner{padding:14px}
.row{display:grid; gap:12px; grid-template-columns:1fr}
.card{ position:relative; background: var(--paper); border:1px solid #e6e1d5; border-radius: 22px;
  box-shadow: 0 18px 30px var(--ring), inset 0 0 0 2px #ffffffd0, inset 0 18px 28px #ffffffa0; padding:12px;
}
.card h2{margin:4px 0 6px; font-size:18px} .muted{color:#5a6a7e; margin:0 0 8px} .kv{font-size:13px; color:#2b3a52}
details{background: radial-gradient(180% 120% at 50% 0%, #ffffff 0 50%, #fff7f2 100%); border:1px solid #e6e1d5; border-radius:16px; padding:10px;
  box-shadow: 0 12px 20px var(--ring), inset 0 0 0 1px #ffffffd0, inset 0 18px 26px #ffffffc0, inset 0 -10px 20px #ffe7d0}
summary{font-weight:900; cursor:pointer} .hr{height:1px;background:linear-gradient(90deg,#0000,#dfe9f5,#0000);margin:8px 0}
.back{display:inline-block;margin:8px 0 0; text-decoration:none; color:#0b2240; border:1px solid #dbe3f0; background:#fff; padding:8px 12px; border-radius:12px; box-shadow:0 6px 10px #00000010}
/* Gallery */
.gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.gallery figure{margin:0; border:1px solid #e6e1d5; border-radius:12px; overflow:hidden; background:#fff}
.gallery img{width:100%; display:block; aspect-ratio:4/3; object-fit:cover}
.gallery figcaption{font-size:12px; padding:6px 8px; color:#445}
.loadbtn{margin:8px 0; padding:8px 12px; border-radius:12px; border:1px solid #cbd6e6; background:#fff}
/* Snow */
.snow, .snow:before, .snow:after{ position:fixed; pointer-events:none; top:0; left:0; right:0; bottom:0; content:"";
  background-image: radial-gradient(2px 2px at 20px 30px, #fff3, #fff0),
                    radial-gradient(3px 3px at 80px 120px, #fff5, #fff0),
                    radial-gradient(2px 2px at 180px 90px, #fff7, #fff0),
                    radial-gradient(2px 2px at 320px 40px, #fff6, #fff0),
                    radial-gradient(3px 3px at 460px 140px, #fff8, #fff0);
  background-repeat:repeat; animation: snow 24s linear infinite; opacity:.85; z-index:0; display:none }
.snow.on, .snow.on:before, .snow.on:after{display:block} .snow:before{animation-duration:36s; opacity:.65} .snow:after{animation-duration:18s; opacity:.95}
@keyframes snow{from{transform:translateY(-10vh)} to{transform:translateY(10vh)}}
@media (min-width:640px){ .row{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body class="home">
<div class="manga-bg" aria-hidden="true"></div>
<div id="snow" class="snow" aria-hidden="true"></div>

<header>
  <div class="bar">
    <h1 class="i18n" data-zh="北海道之旅 · 網頁版（漫畫風）" data-en="Hokkaido Trip · Web (Cartoon)">北海道之旅 · 網頁版（漫畫風）</h1>
    <div class="lang">
      <button id="btn-zh" class="on">中文</button>
      <button id="btn-en">English</button>
    </div>
  </div>
</header>

<main>
  <div class="homebar">
    <div class="input"><span class="i18n" data-zh="出發日期" data-en="Start Date">出發日期</span> <input id="start" type="date"></div>
    <div class="wx" id="wx-home">
      <div class="t i18n" data-zh="札幌 天氣（Day 1）" data-en="Sapporo Weather (Day 1)">札幌 天氣（Day 1）</div>
      <small id="wx-home-date">—</small>
      <div class="item"><b class="i18n" data-zh="狀況" data-en="Condition">狀況</b> <div class="v" id="wh-cond">—</div></div>
      <div class="item"><b class="i18n" data-zh="最高/最低" data-en="Max/Min">最高/最低</b> <div class="v"><span id="wh-tmax">—</span>/<span id="wh-tmin">—</span> °C</div></div>
      <div class="item"><b class="i18n" data-zh="降水" data-en="Precip">降水</b> <div class="v" id="wh-pop">—%</div></div>
      <div class="item"><b class="i18n" data-zh="風" data-en="Wind">風</b> <div class="v"><span id="wh-wspd">—</span> km/h · <span id="wh-wdir">—</span></div></div>
    </div>
  </div>

  <!-- Day buttons -->
  <div class="grid">
    <a class="btn" href="#day3"><div class="left"><span class="emoji">🐧</span><span class="i18n" data-zh="Day 3 旭山＋美瑛＋精靈露台" data-en="Day 3 Asahiyama + Biei + Ningle Terrace">Day 3 旭山＋美瑛＋精靈露台</span></div><span class="tag">Long Drive</span><span class="chev">›</span></a>
    <a class="btn" href="#day5"><div class="left"><span class="emoji">🏮</span><span class="i18n" data-zh="Day 5 小樽一日遊" data-en="Day 5 Otaru Day Trip">Day 5 小樽一日遊</span></div><span class="tag">Otaru</span><span class="chev">›</span></a>
    <a class="btn" href="#day8"><div class="left"><span class="emoji">♨️</span><span class="i18n" data-zh="Day 8 登別周邊 · Combo A" data-en="Day 8 Noboribetsu Area · Combo A">Day 8 登別周邊 · Combo A</span></div><span class="tag">Onsen</span><span class="chev">›</span></a>
  </div>

  <!-- Day 3 -->
  <section class="section" id="day3">
    <a class="back" href="#home">← <span class="i18n" data-zh="返回首頁" data-en="Back to Home">返回首頁</span></a>
    <div class="hero"><div class="inner">
      <div class="wx">
        <div class="t i18n" data-zh="旭川/美瑛 天氣（Day 3）" data-en="Asahikawa/Biei Weather (Day 3)">旭川/美瑛 天氣（Day 3）</div><small id="wx-3-date">—</small>
        <div class="item"><b class="i18n" data-zh="狀況" data-en="Condition">狀況</b> <div class="v" id="w3-cond">—</div></div>
        <div class="item"><b class="i18n" data-zh="最高/最低" data-en="Max/Min">最高/最低</b> <div class="v"><span id="w3-tmax">—</span>/<span id="w3-tmin">—</span> °C</div></div>
        <div class="item"><b class="i18n" data-zh="降水" data-en="Precip">降水</b> <div class="v" id="w3-pop">—%</div></div>
        <div class="item"><b class="i18n" data-zh="風" data-en="Wind">風</b> <div class="v"><span id="w3-wspd">—</span> km/h · <span id="w3-wdir">—</span></div></div>
      </div>
      <h2>Asahiyama Zoo → Blue Pond → Ningle Terrace</h2>
      <div class="row">
        <div class="card">
          <h2 class="i18n" data-zh="地圖與停車" data-en="Maps & Parking">地圖與停車</h2>
          <ul class="kv">
            <li>旭山動物園：
              <a target="_blank" href="https://maps.google.com/?q=Asahiyama+Zoo">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/%E9%A7%90%E8%BB%8A%E5%A0%B4+%E6%97%AD%E5%B1%B1%E5%8B%95%E7%89%A9%E5%9C%92">Parking A</a> ·
              <a target="_blank" href="https://www.google.com/maps/search/parking+Asahiyama+Zoo+P2">Parking B</a>
            </li>
            <li>美瑛 青池：
              <a target="_blank" href="https://maps.google.com/?q=Biei+Blue+Pond">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/%E9%9D%92%E6%B1%A0+%E9%A7%90%E8%BB%8A%E5%A0%B4">Parking A</a> ·
              <a target="_blank" href="https://www.google.com/maps/search/parking+Blue+Pond+Biei+lot">Parking B</a>
            </li>
            <li>富良野 精靈露台：
              <a target="_blank" href="https://maps.google.com/?q=Ningle+Terrace">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/parking+Ningle+Terrace">Parking A</a>
            </li>
          </ul>
          <div class="hr"></div>
          <b class="i18n" data-zh="景點圖集" data-en="Spot Galleries">景點圖集</b>
          <ul class="kv">
            <li><a href="#spot-penguins">🐧 旭山動物園 · 企鵝散步</a></li>
            <li><a href="#spot-bluepond">🔵 美瑛 · 青池</a></li>
          </ul>
        </div>
        <div class="card">
          <h2 class="i18n" data-zh="行程備註" data-en="Notes">行程備註</h2>
          <div class="kv i18n" data-zh="留意企鵝遊行時間；冬季道路結冰，預留緩衝。" data-en="Check penguin parade times; allow buffer for icy roads.">留意企鵝遊行時間；冬季道路結冰，預留緩衝。</div>
        </div>
      </div>
    </div></div>
  </section>

  <!-- Day 5 -->
  <section class="section" id="day5">
    <a class="back" href="#home">← <span class="i18n" data-zh="返回首頁" data-en="Back to Home">返回首頁</span></a>
    <div class="hero"><div class="inner">
      <div class="wx">
        <div class="t i18n" data-zh="小樽 天氣（Day 5）" data-en="Otaru Weather (Day 5)">小樽 天氣（Day 5）</div><small id="wx-5-date">—</small>
        <div class="item"><b class="i18n" data-zh="狀況" data-en="Condition">狀況</b> <div class="v" id="w5-cond">—</div></div>
        <div class="item"><b class="i18n" data-zh="最高/最低" data-en="Max/Min">最高/最低</b> <div class="v"><span id="w5-tmax">—</span>/<span id="w5-tmin">—</span> °C</div></div>
        <div class="item"><b class="i18n" data-zh="降水" data-en="Precip">降水</b> <div class="v" id="w5-pop">—%</div></div>
        <div class="item"><b class="i18n" data-zh="風" data-en="Wind">風</b> <div class="v"><span id="w5-wspd">—</span> km/h · <span id="w5-wdir">—</span></div></div>
      </div>
      <h2>Otaru Canal · Music Box Museum · Sankaku Market</h2>
      <div class="row">
        <div class="card">
          <h2 class="i18n" data-zh="地圖與停車" data-en="Maps & Parking">地圖與停車</h2>
          <ul class="kv">
            <li>小樽運河：
              <a target="_blank" href="https://maps.google.com/?q=Otaru+Canal">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/%E5%B0%8F%E6%A8%BD+%E9%81%8B%E6%B2%B3+%E9%A7%90%E8%BB%8A%E5%A0%B4">Parking A</a> ·
              <a target="_blank" href="https://www.google.com/maps/search/parking+Otaru+Canal+lot">Parking B</a>
            </li>
            <li>小樽音樂盒堂：
              <a target="_blank" href="https://maps.google.com/?q=Otaru+Music+Box+Museum">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/parking+Otaru+Music+Box+Museum">Parking A</a>
            </li>
            <li>三角市場：
              <a target="_blank" href="https://maps.google.com/?q=Otaru+Sankaku+Market">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/%E4%B8%89%E8%A7%92%E5%B8%82%E5%A0%B4+%E9%A7%90%E8%BB%8A%E5%A0%B4">Parking A</a>
            </li>
          </ul>
          <div class="hr"></div>
          <b class="i18n" data-zh="景點圖集" data-en="Spot Galleries">景點圖集</b>
          <ul class="kv">
            <li><a href="#spot-otaru">🏮 小樽運河 · 夜色</a></li>
          </ul>
        </div>
        <div class="card">
          <h2 class="i18n" data-zh="餐廳地圖" data-en="Dining Maps">餐廳地圖</h2>
          <ul class="kv">
            <li><a target="_blank" href="https://maps.google.com/?q=Tanigawa+Shokudo+Sankaku+Market">滝波食堂（三角市場）</a></li>
            <li><a target="_blank" href="https://maps.google.com/?q=Masazushi+Otaru">政壽司 本店</a></li>
          </ul>
        </div>
      </div>
    </div></div>
  </section>

  <!-- Day 8 -->
  <section class="section" id="day8">
    <a class="back" href="#home">← <span class="i18n" data-zh="返回首頁" data-en="Back to Home">返回首頁</span></a>
    <div class="hero"><div class="inner">
      <div class="wx">
        <div class="t i18n" data-zh="登別 天氣（Day 8）" data-en="Noboribetsu Weather (Day 8)">登別 天氣（Day 8）</div><small id="wx-8-date">—</small>
        <div class="item"><b class="i18n" data-zh="狀況" data-en="Condition">狀況</b> <div class="v" id="w8-cond">—</div></div>
        <div class="item"><b class="i18n" data-zh="最高/最低" data-en="Max/Min">最高/最低</b> <div class="v"><span id="w8-tmax">—</span>/<span id="w8-tmin">—</span> °C</div></div>
        <div class="item"><b class="i18n" data-zh="降水" data-en="Precip">降水</b> <div class="v" id="w8-pop">—%</div></div>
        <div class="item"><b class="i18n" data-zh="風" data-en="Wind">風</b> <div class="v"><span id="w8-wspd">—</span> km/h · <span id="w8-wdir">—</span></div></div>
      </div>
      <h2>Jigokudani → Oyunuma → Onsen Street</h2>
      <div class="row">
        <div class="card">
          <h2 class="i18n" data-zh="地圖與停車" data-en="Maps & Parking">地圖與停車</h2>
          <ul class="kv">
            <li>地獄谷：
              <a target="_blank" href="https://maps.google.com/?q=Noboribetsu+Jigokudani">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/%E7%99%BB%E5%88%A5+%E5%9C%B0%E7%8D%84%E8%B0%B7+%E9%A7%90%E8%BB%8A%E5%A0%B4">Parking A</a> ·
              <a target="_blank" href="https://www.google.com/maps/search/Jigokudani+parking+lot+Noboribetsu">Parking B</a>
            </li>
            <li>大湯沼/奧之湯：
              <a target="_blank" href="https://maps.google.com/?q=Oyunuma+Noboribetsu">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/Oyunuma+parking+Noboribetsu">Parking A</a>
            </li>
            <li>泉源公園：
              <a target="_blank" href="https://maps.google.com/?q=Gensen+Park+Noboribetsu">地圖</a> · 
              <a target="_blank" href="https://www.google.com/maps/search/Gensen+Park+parking+Noboribetsu">Parking A</a>
            </li>
          </ul>
          <div class="hr"></div>
          <b class="i18n" data-zh="景點圖集" data-en="Spot Galleries">景點圖集</b>
          <ul class="kv">
            <li><a href="#spot-jigokudani">🔥 登別 · 地獄谷</a></li>
            <li><a href="#spot-oyunuma">♨️ 登別 · 大湯沼</a></li>
          </ul>
        </div>
        <div class="card">
          <h2 class="i18n" data-zh="用餐建議" data-en="Food">用餐建議</h2>
          <ul class="kv">
            <li><a target="_blank" href="https://maps.google.com/?q=Sentei+Noboribetsu">泉亭</a></li>
            <li><a target="_blank" href="https://maps.google.com/?q=Aji+no+Daio+Noboribetsu">味の大王（咖喱拉麵）</a></li>
            <li><a target="_blank" href="https://maps.google.com/?q=Dai-ichi+Takimotokan">第一滝本館（住宿/溫泉）</a></li>
          </ul>
        </div>
      </div>
    </div></div>
  </section>

  <!-- Spot pages with DYNAMIC galleries (Wikimedia API) -->
  <section class="section" id="spot-penguins">
    <a class="back" href="#day3">← Day 3</a>
    <div class="hero"><div class="inner">
      <h2>Asahiyama Zoo · Penguin Parade</h2>
      <button class="loadbtn" onclick="loadGallery(this,'Asahiyama Zoo penguin parade Hokkaido',8)">載入 8 張圖片 / Load 8 photos</button>
      <div class="gallery"></div>
      <p class="muted">來源：Wikimedia Commons（即時載入，含作者與授權資訊）。</p>
    </div></div>
  </section>

  <section class="section" id="spot-bluepond">
    <a class="back" href="#day3">← Day 3</a>
    <div class="hero"><div class="inner">
      <h2>Biei · Blue Pond</h2>
      <button class="loadbtn" onclick="loadGallery(this,'Biei Blue Pond Hokkaido winter',8)">載入 8 張圖片 / Load 8 photos</button>
      <div class="gallery"></div>
      <p class="muted">來源：Wikimedia Commons。</p>
    </div></div>
  </section>

  <section class="section" id="spot-otaru">
    <a class="back" href="#day5">← Day 5</a>
    <div class="hero"><div class="inner">
      <h2>Otaru Canal · Night</h2>
      <button class="loadbtn" onclick="loadGallery(this,'Otaru Canal night winter',8)">載入 8 張圖片 / Load 8 photos</button>
      <div class="gallery"></div>
      <p class="muted">來源：Wikimedia Commons。</p>
    </div></div>
  </section>

  <section class="section" id="spot-jigokudani">
    <a class="back" href="#day8">← Day 8</a>
    <div class="hero"><div class="inner">
      <h2>Noboribetsu · Jigokudani</h2>
      <button class="loadbtn" onclick="loadGallery(this,'Noboribetsu Jigokudani Hell Valley',8)">載入 8 張圖片 / Load 8 photos</button>
      <div class="gallery"></div>
      <p class="muted">來源：Wikimedia Commons。</p>
    </div></div>
  </section>

  <section class="section" id="spot-oyunuma">
    <a class="back" href="#day8">← Day 8</a>
    <div class="hero"><div class="inner">
      <h2>Noboribetsu · Oyunuma</h2>
      <button class="loadbtn" onclick="loadGallery(this,'Oyunuma Pond Noboribetsu',8)">載入 8 張圖片 / Load 8 photos</button>
      <div class="gallery"></div>
      <p class="muted">來源：Wikimedia Commons。</p>
    </div></div>
  </section>
</main>

<script>
// Basic i18n + weather (same as before, trimmed)
let currentLang='zh';
const WMO_ZH={0:'晴',1:'多雲(少)',2:'多雲(間歇)',3:'陰',45:'霧',48:'霧凍',51:'毛毛雨(輕)',53:'毛毛雨(中)',55:'毛毛雨(強)',56:'冰毛毛雨(輕)',57:'冰毛毛雨(強)',61:'小雨',63:'中雨',65:'大雨',66:'凍雨(輕)',67:'凍雨(強)',71:'小雪',73:'中雪',75:'大雪',77:'雪粒',80:'陣雨(輕)',81:'陣雨(中)',82:'陣雨(強)',85:'陣雪(輕)',86:'陣雪(強)',95:'雷雨',96:'雷雨(小冰雹)',99:'雷雨(大冰雹)'};
const WMO_EN={0:'Clear',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Fog',48:'Depositing rime fog',51:'Drizzle (light)',53:'Drizzle (moderate)',55:'Drizzle (dense)',56:'Freezing drizzle (light)',57:'Freezing drizzle (dense)',61:'Rain (light)',63:'Rain (moderate)',65:'Rain (heavy)',66:'Freezing rain (light)',67:'Freezing rain (heavy)',71:'Snow (light)',73:'Snow (moderate)',75:'Snow (heavy)',77:'Snow grains',80:'Rain showers (light)',81:'Rain showers (moderate)',82:'Rain showers (violent)',85:'Snow showers (light)',86:'Snow showers (heavy)',95:'Thunderstorm',96:'Thunderstorm (slight hail)',99:'Thunderstorm (heavy hail)'};
const dirText=(deg,lang='zh')=>{const zh=['北','北北東','北東','東北東','東','東南東','南東','南南東','南','南南西','南西','西南西','西','西北西','北西','北北西']; const en=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']; const ix=Math.round(deg/22.5)%16; return (lang==='en'?en:zh)[ix]};
const LOC={home:{lat:43.0618,lon:141.3545},3:{lat:43.7706,lon:142.3650},5:{lat:43.1907,lon:141.0028},8:{lat:42.4124,lon:141.1069}};

function qs(s,root=document){return root.querySelector(s)}; function setText(sel,v){const el=qs(sel); if(el) el.textContent=v}; function fmt(n){return (n==null||Number.isNaN(n))?'—':Math.round(n)};
function getDates(startStr){const start=new Date(startStr); return [...Array(9)].map((_,i)=>{const d=new Date(start); d.setDate(start.getDate()+i); return d.toISOString().slice(0,10)})}
function initStartDate(){const input=qs('#start'); if(!input.value){const t=new Date(); const y=t.getFullYear(),m=('0'+(t.getMonth()+1)).slice(-2),d=('0'+t.getDate()).slice(-2); input.value=`${y}-${m}-${d}`;}}
async function fetchDay(lat,lon,date,lang){const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max,wind_direction_10m_dominant&timezone=Asia%2FTokyo&start_date=${date}&end_date=${date}`; const r=await fetch(url); const j=await r.json(); const map=lang==='en'?WMO_EN:WMO_ZH; const i=0; const code=j.daily.weather_code[i]; return {cond:map[code]||code,tmax:j.daily.temperature_2m_max[i],tmin:j.daily.temperature_2m_min[i],pop:j.daily.precipitation_probability_max[i],wspd:j.daily.wind_speed_10m_max[i],wdir:j.daily.wind_direction_10m_dominant?.[i]};}
async function loadWeather(){const lang=currentLang; const start=qs('#start').value; const dates=getDates(start);
  setText('#wx-home-date',dates[0]);
  try{const d=await fetchDay(LOC.home.lat,LOC.home.lon,dates[0],lang); setText('#wh-cond',d.cond); setText('#wh-tmax',fmt(d.tmax)); setText('#wh-tmin',fmt(d.tmin)); setText('#wh-pop',(d.pop??'—')+'%'); setText('#wh-wspd',fmt(d.wspd)); setText('#wh-wdir',d.wdir!=null?dirText(d.wdir,lang):'—');}catch(e){setText('#wh-cond',lang==='en'?'Failed':'無法取得');}
  const pairs=[[3,'#wx-3-date','#w3-'],[5,'#wx-5-date','#w5-'],[8,'#wx-8-date','#w8-']];
  for(const [day,idPrefix,pre] of pairs){
    const date=day===3?dates[2]:day===5?dates[4]:dates[7];
    setText(idPrefix,date);
    try{const d=await fetchDay(LOC[day].lat,LOC[day].lon,date,lang); setText(pre+'cond',d.cond); setText(pre+'tmax',fmt(d.tmax)); setText(pre+'tmin',fmt(d.tmin)); setText(pre+'pop',(d.pop??'—')+'%'); setText(pre+'wspd',fmt(d.wspd)); setText(pre+'wdir',d.wdir!=null?dirText(d.wdir,lang):'—');}catch(e){setText(pre+'cond',lang==='en'?'Failed':'無法取得');}
  }
}
function updateMode(){const isDetail=location.hash && (location.hash.startsWith('#day') || location.hash.startsWith('#spot')); document.body.className=isDetail?'detail':'home'; qs('#snow').classList.toggle('on', isDetail);}
const applyLang=(lang)=>{currentLang=lang; document.querySelectorAll('.i18n').forEach(el=>{const zh=el.getAttribute('data-zh'); const en=el.getAttribute('data-en'); if(lang==='en'&&en) el.textContent=en; else if(zh) el.textContent=zh;}); document.getElementById('btn-zh').classList.toggle('on',lang==='zh'); document.getElementById('btn-en').classList.toggle('on',lang==='en'); loadWeather();};
document.getElementById('btn-zh').addEventListener('click',()=>applyLang('zh')); document.getElementById('btn-en').addEventListener('click',()=>applyLang('en'));
document.getElementById('start').addEventListener('change',loadWeather);
window.addEventListener('hashchange',updateMode);
initStartDate(); applyLang('zh'); updateMode(); loadWeather();

// Wikimedia Commons dynamic gallery loader
async function loadGallery(button, query, count=8){
  const wrap = button.nextElementSibling;
  button.disabled = true; button.textContent = (currentLang==='en'?'Loading...':'載入中…');
  try{
    const url = new URL('https://commons.wikimedia.org/w/api.php');
    url.searchParams.set('action','query');
    url.searchParams.set('format','json');
    url.searchParams.set('origin','*');
    url.searchParams.set('prop','imageinfo');
    url.searchParams.set('generator','search');
    url.searchParams.set('gsrsearch', query + ' filetype:bitmap');
    url.searchParams.set('gsrlimit', count);
    url.searchParams.set('iiprop','url|extmetadata');
    url.searchParams.set('iiurlwidth','1024');
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    const pages = j.query && j.query.pages ? Object.values(j.query.pages) : [];
    wrap.innerHTML = '';
    let got = 0;
    for(const p of pages){
      const info = p.imageinfo && p.imageinfo[0];
      if(!info) continue;
      const thumb = info.thumburl || info.url;
      const meta = info.extmetadata || {};
      const artist = meta.Artist ? (meta.Artist.value || '').replace(/<[^>]*>/g,'') : '';
      const license = meta.LicenseShortName ? meta.LicenseShortName.value : (meta.License ? meta.License.value : '');
      const credit = (artist?artist+' · ':'') + (license?license:'CC / GFDL');
      const filepage = info.descriptionshorturl || info.descriptionurl || info.url;
      wrap.insertAdjacentHTML('beforeend',
        `<figure>
           <a href="${filepage}" target="_blank" rel="noopener">
             <img loading="lazy" src="${thumb}" alt="${p.title}">
           </a>
           <figcaption>${credit}</figcaption>
         </figure>`);
      got++;
    }
    if(got===0){
      wrap.innerHTML = '<div class="kv">未找到圖片 / No images found.</div>';
    }else{
      button.textContent = (currentLang==='en'?'Reload images':'重新載入圖片');
      button.disabled = false;
    }
  }catch(e){
    wrap.innerHTML = '<div class="kv">載入失敗 / Failed to load.</div>';
    button.disabled = false; button.textContent = (currentLang==='en'?'Load 8 photos':'載入 8 張圖片');
  }
}
</script>
</body>
</html>
