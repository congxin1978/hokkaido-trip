<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>北海道之旅 · 卡通貼紙版（飄雪＋BGM）</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
<style>
:root{
  --sky:#e9f5ff; --ink:#0f1630;
  --pink1:#ff8fb1; --pink2:#ffd1e6;
  --wxbg:#183a6d; --wxline:#3e72b9; --wxitem:#0f2950;
  --ring:#00000020;
  --c1:#ffd35a; --c2:#6ee7c8; --c3:#7fb8ff; --c4:#b28cff; --c5:#ff9f6c;
  --c6:#ffa3d1; --c7:#f6c445; --c8:#ff6b88; --c9:#9ad891;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Baloo 2","Zen Maru Gothic",ui-rounded,system-ui;color:var(--ink);background:linear-gradient(180deg,var(--sky),#fff 70%)}
header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--pink1),var(--pink2));border-bottom:2px solid #ffd9ee;box-shadow:0 8px 18px #0002}
.bar{max-width:1200px;margin:0 auto;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:22px;color:#4a1a2a;text-shadow:0 2px 0 #fff8,0 10px 20px #ff9ec244;display:flex;align-items:center;gap:10px}
.lang,.audio{display:flex;gap:8px;align-items:center}
.lang button,.audio button{border:2px solid #fff8;background:#fff;border-radius:12px;padding:6px 10px;box-shadow:0 6px 12px #0001;font-weight:800}
.lang .on{background:#ffe8f2}
main{max-width:1000px;margin:16px auto 100px;padding:0 14px}
/* Snow */
.snow,.snow:before,.snow:after{position:fixed;inset:0;pointer-events:none;content:"";background-image:
  radial-gradient(2px 2px at 20px 30px,#fff6,#0000),radial-gradient(3px 3px at 80px 120px,#fff7,#0000),
  radial-gradient(2px 2px at 180px 90px,#fff8,#0000),radial-gradient(2px 2px at 320px 40px,#fff9,#0000),
  radial-gradient(3px 3px at 460px 140px,#ffff,#0000);background-repeat:repeat;animation:snow 24s linear infinite;opacity:.9;display:none;z-index:0}
.snow.on,.snow.on:before,.snow.on:after{display:block}
.snow:before{animation-duration:36s;opacity:.7}.snow:after{animation-duration:18s;opacity:1}
@keyframes snow{from{transform:translateY(-10vh)}to{transform:translateY(10vh)}}
/* Weather */
.wx{margin:8px 0 16px;padding:10px;border:1px solid var(--wxline);border-radius:18px;background:var(--wxbg);color:#e8f2ff;display:flex;flex-wrap:wrap;gap:10px;align-items:center;box-shadow:0 10px 18px #0004}
.wx .t{font-weight:900}.wx small{color:#bcd6ff}.wx .item{flex:1 1 160px;background:var(--wxitem);border:1px dashed var(--wxline);border-radius:12px;padding:8px}
.wx .item b{font-size:12px;color:#cfe0ff}.wx .v{font-size:18px;font-weight:800}
/* Sticker Grid (home) */
.stickers{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;justify-items:center;margin-top:14px}
@media(min-width:720px){.stickers{grid-template-columns:repeat(3,1fr)}}
.sticker{width:120px;height:120px;border-radius:50%;position:relative;display:grid;place-items:center;text-decoration:none;color:#123;
  box-shadow:0 12px 0 #00000030, 0 18px 30px #0005; border:3px solid #fff; background:#fff8; backdrop-filter:blur(2px)}
.sticker .plate{width:108px;height:108px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:900;
  box-shadow:inset 0 10px 18px #0002;}
.sticker .label{position:absolute;bottom:-22px;width:140px;text-align:center;font-weight:900;font-size:14px;color:#234;
  text-shadow:0 1px 0 #fff8}
/* wonky angles */
.sticker:nth-child(1){transform:rotate(-6deg) translateY(2px)}
.sticker:nth-child(2){transform:rotate(4deg) translateY(-4px)}
.sticker:nth-child(3){transform:rotate(-2.5deg) translateY(5px)}
.sticker:nth-child(4){transform:rotate(3.5deg) translateX(-4px)}
.sticker:nth-child(5){transform:rotate(-5.5deg) translateX(3px)}
.sticker:nth-child(6){transform:rotate(2.5deg)}
.sticker:nth-child(7){transform:rotate(-3deg)}
.sticker:nth-child(8){transform:rotate(5deg) translateY(-3px)}
.sticker:nth-child(9){transform:rotate(-1.5deg) translateY(2px)}
/* icon size */
.sticker svg{width:60px;height:60px;filter:drop-shadow(0 2px 2px #0003)}
.c1{background:linear-gradient(180deg,var(--c1),#ffb839)} .c2{background:linear-gradient(180deg,var(--c2),#2fb79b)}
.c3{background:linear-gradient(180deg,var(--c3),#4590ff)} .c4{background:linear-gradient(180deg,var(--c4),#8b5cf6)}
.c5{background:linear-gradient(180deg,var(--c5),#ff7a3c)} .c6{background:linear-gradient(180deg,var(--c6),#ff79b5)}
.c7{background:linear-gradient(180deg,var(--c7),#e4a90e)} .c8{background:linear-gradient(180deg,var(--c8),#ff3d66)}
.c9{background:linear-gradient(180deg,var(--c9),#5bbf6b)}
/* Sections / cards */
.section{display:none;margin-top:22px}.section:target{display:block}
.hero{border:1px solid #e3edf8;border-radius:22px;background:#fff;box-shadow:0 18px 30px var(--ring)}.hero .inner{padding:14px}
.row{display:grid;gap:12px;grid-template-columns:1fr}
.card{background:#fffdfc;border:1px solid #efe6d9;border-radius:18px;box-shadow:0 10px 20px var(--ring);padding:12px}
.card h2{margin:6px 0;font-size:18px}
.kv{font-size:14px}
.back{display:inline-block;margin:10px 0;padding:8px 12px;border-radius:12px;background:#fff;border:1px solid #e3edf8;color:#123;text-decoration:none}
.gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.gallery figure{margin:0;border:1px solid #e6e1d5;border-radius:12px;overflow:hidden;background:#fff}
.gallery img{width:100%;display:block}.gallery figcaption{font-size:12px;padding:6px 8px;color:#445}
.placeholder{display:grid;place-items:center;aspect-ratio:4/3;background:repeating-linear-gradient(45deg,#eef2f7,#eef2f7 8px,#e5ecf4 8px,#e5ecf4 16px);color:#567}
.thumb{width:56px;height:42px;object-fit:cover;border-radius:6px;margin-left:10px;vertical-align:middle;border:1px solid #e6e1d5}
@media(min-width:640px){.row{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div id="snow" class="snow"></div>
<header>
  <div class="bar">
    <h1>🌸 北海道之旅 · 貼紙首頁</h1>
    <div class="audio">
      <button id="bgm-toggle">🎵 背景音樂：關</button>
      <button id="snow-toggle">❄️ 飄雪：開</button>
    </div>
    <div class="lang">
      <button id="btn-zh" class="on">中文</button>
      <button id="btn-en">English</button>
    </div>
  </div>
</header>

<main id="app">
  <div class="wx">
    <div class="t">札幌 天氣（Day 1）</div>
    <small id="wx-home-date">—</small>
    <div class="item"><b>狀況</b><div class="v" id="wh-cond">—</div></div>
    <div class="item"><b>最高/最低</b><div class="v"><span id="wh-tmax">—</span>/<span id="wh-tmin">—</span> °C</div></div>
    <div class="item"><b>降水</b><div class="v" id="wh-pop">—%</div></div>
    <div class="item"><b>風</b><div class="v"><span id="wh-wspd">—</span> km/h · <span id="wh-wdir">—</span></div></div>
  </div>

  <div class="stickers" id="stickers"></div>
  <div id="sections"></div>
</main>

<script>
let currentLang='zh';
const ICONS={
  plane:`<svg viewBox="0 0 24 24"><path d="M2 13l9 1 10 6-2 2-8-7-5 4-2-1 4-5-6-0z" fill="#fff"/></svg>`,
  crab:`<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="4.5" fill="#fff"/><circle cx="8.5" cy="10.5" r="1" fill="#ff3d66"/><circle cx="15.5" cy="10.5" r="1" fill="#ff3d66"/><path d="M4 9c2 0 2.5 1.5 3.5 2.5M20 9c-2 0-2.5 1.5-3.5 2.5" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>`,
  penguin:`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3c3 0 5 2.5 5 6v7c0 2.2-1.8 4-4 4h-2c-2.2 0-4-1.8-4-4V9c0-3.5 2-6 5-6z" fill="#fff"/><ellipse cx="12" cy="11" rx="2.4" ry="3.2" fill="#000"/></svg>`,
  snowman:`<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="15" r="5" fill="#fff"/><circle cx="12" cy="8" r="3.5" fill="#fff"/></svg>`,
  cart:`<svg viewBox="0 0 24 24" fill="none"><path d="M3 5h2l2 10h10l2-7H8" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="19" r="1.5" fill="#fff"/><circle cx="17" cy="19" r="1.5" fill="#fff"/></svg>`,
  cat:`<svg viewBox="0 0 24 24" fill="none"><path d="M6 8l-1-3 3 1 2-2 2 2 3-1-1 3" stroke="#fff" stroke-width="2" stroke-linecap="round"/><ellipse cx="12" cy="14" rx="6" ry="5" fill="#fff"/></svg>`,
  fatcat:`<svg viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="13" rx="7" ry="6" fill="#fff"/></svg>`,
  onsen:`<svg viewBox="0 0 24 24" fill="none"><path d="M4 17c4 3 12 3 16 0" stroke="#fff" stroke-width="2"/><path d="M8 6c-2 3 2 3 0 6m4-6c-2 3 2 3 0 6m4-6c-2 3 2 3 0 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>`
};

const DAYS=[
  {id:1,icon:'plane',color:'c1',zh:'Day 1 抵達札幌',en:'Arrival',place:{lat:43.0618,lon:141.3545},
    sights:[{id:'cts',zh:'新千歲機場 → 札幌',en:'New Chitose → Sapporo',map:'https://maps.google.com/?q=New+Chitose+Airport',parking:['https://www.google.com/maps/search/parking+New+Chitose+Airport'],imgs:[
      ['https://upload.wikimedia.org/wikipedia/commons/9/9a/New_Chitose_Airport.jpg','Wikimedia'],
      ['https://upload.wikimedia.org/wikipedia/commons/5/52/Sapporo_skyline.jpg','Wikimedia'],null,null,null,null]}],
    dining:[{zh:'一粒庵（味噌拉麵）',en:'Ichiryuan',map:'https://maps.google.com/?q=Ichiryuan+Sapporo'}]
  },
  {id:2,icon:'crab',color:'c2',zh:'Day 2 吃蟹＋玩雪',en:'Crab & Snow',place:{lat:43.0618,lon:141.3545},
    sights:[
      {id:'curb',zh:'札幌 場外市場',en:'Sapporo Curb Market',map:'https://maps.google.com/?q=Sapporo+Curb+Market',parking:['https://www.google.com/maps/search/parking+Sapporo+Curb+Market'],imgs:[
        ['https://upload.wikimedia.org/wikipedia/commons/9/9a/Nijo_Fish_Market_Sapporo.jpg','Wikimedia'],
        ['https://upload.wikimedia.org/wikipedia/commons/3/38/Hokkaido_seafood_at_market_2017.jpg','Wikimedia'],null,null,null,null]},
      {id:'takino',zh:'滝野鈴蘭 Snow World',en:'Takino Suzuran Snow World',map:'https://maps.google.com/?q=Takino+Suzuran+Hillside+National+Government+Park',parking:['https://www.google.com/maps/search/parking+Takino+Suzuran+Hillside+Park'],imgs:[
        ['https://upload.wikimedia.org/wikipedia/commons/0/08/Takino_Suzuran_Park_in_winter.jpg','Wikimedia'],
        ['https://upload.wikimedia.org/wikipedia/commons/1/1a/Takino_Suzuran_Hillside_National_Government_Park_Sapporo.jpg','Wikimedia'],null,null,null,null]}
    ],
    dining:[{zh:'北のグルメ亭',en:'Kitanogurume Tei',map:'https://maps.google.com/?q=Kitanogurume+Tei'}]
  },
  {id:3,icon:'penguin',color:'c3',zh:'Day 3 旭山＋美瑛＋精靈露台',en:'Zoo + Biei + Ningle',place:{lat:43.7706,lon:142.3650},
    sights:[
      {id:'zoo',zh:'旭山動物園 企鵝散步',en:'Asahiyama Penguin Walk',map:'https://maps.google.com/?q=Asahiyama+Zoo',parking:['https://www.google.com/maps/search/parking+Asahiyama+Zoo'],imgs:[
        ['https://upload.wikimedia.org/wikipedia/commons/8/85/AsahiyamaZoo-PenguinsParade.jpg','Birdman (CC BY-SA/GFDL)'],
        ['https://upload.wikimedia.org/wikipedia/commons/5/58/Asahiyama_Zoo_penguin_walk_2019.jpg','Wikimedia'],null,null,null,null]},
      {id:'bluepond',zh:'美瑛 青池',en:'Biei Blue Pond',map:'https://maps.google.com/?q=Biei+Blue+Pond',parking:['https://www.google.com/maps/search/parking+Blue+Pond+Biei'],imgs:[
        ['https://upload.wikimedia.org/wikipedia/commons/4/4f/Biei_Blue-pond.jpg','MaedaAkihiko (CC BY-SA 4.0)'],
        ['https://upload.wikimedia.org/wikipedia/commons/6/69/Aoi-ike_Blue_Pond_in_Winter_2012_%288355206648%29.jpg','Wikimedia'],null,null,null,null]},
      {id:'ningle',zh:'富良野 精靈露台',en:'Ningle Terrace',map:'https://maps.google.com/?q=Ningle+Terrace',parking:['https://www.google.com/maps/search/parking+Ningle+Terrace'],imgs:[
        ['https://upload.wikimedia.org/wikipedia/commons/2/2e/Ningle_Terrace_in_winter.jpg','Wikimedia'],
        ['https://upload.wikimedia.org/wikipedia/commons/3/36/Ningle_Terrace_Furano.jpg','Wikimedia'],null,null,null,null]}
    ],
    dining:[{zh:'旭川拉麵村 青葉',en:'Aoba (Ramen Village)',map:'https://maps.google.com/?q=Asahikawa+Ramen+Village+Aoba'}]
  },
  {id:4,icon:'snowman',color:'c4',zh:'Day 4 白色戀人公園＋市區',en:'Shiroi Koibito + City',place:{lat:43.0618,lon:141.3545},
    sights:[{id:'white',zh:'白色戀人公園',en:'Shiroi Koibito Park',map:'https://maps.google.com/?q=Shiroi+Koibito+Park',parking:['https://www.google.com/maps/search/parking+Shiroi+Koibito+Park'],imgs:[
      ['https://upload.wikimedia.org/wikipedia/commons/4/49/Shiroi_Koibito_Park_2018.jpg','Wikimedia'],
      ['https://upload.wikimedia.org/wikipedia/commons/8/8a/Shiroi_Koibito_Park_clocktower.jpg','Wikimedia'],null,null,null,null]}],
    dining:[]
  },
  {id:5,icon:'cart',color:'c5',zh:'Day 5 小樽一日',en:'Otaru Day',place:{lat:43.1907,lon:141.0028},
    sights:[{id:'canal',zh:'小樽運河',en:'Otaru Canal',map:'https://maps.google.com/?q=Otaru+Canal',parking:['https://www.google.com/maps/search/parking+Otaru+Canal'],imgs:[
      ['https://upload.wikimedia.org/wikipedia/commons/e/e2/Otaru_Canal_winter.jpg','Wikimedia'],
      ['https://upload.wikimedia.org/wikipedia/commons/f/f8/Otaru_Canal_at_night.jpg','Wikimedia'],null,null,null,null]}],
    dining:[{zh:'政壽司',en:'Masazushi',map:'https://maps.google.com/?q=Masazushi+Otaru'}]
  },
  {id:6,icon:'cat',color:'c6',zh:'Day 6 札幌休閒購物',en:'Leisure & Shopping',place:{lat:43.0618,lon:141.3545},
    sights:[{id:'outlets',zh:'北廣島 三井 OUTLET',en:'Mitsui Outlet Park',map:'https://maps.google.com/?q=Mitsui+Outlet+Park+Kitahiroshima',parking:['https://www.google.com/maps/search/parking+Mitsui+Outlet+Park+Kitahiroshima'],imgs:[
      ['https://upload.wikimedia.org/wikipedia/commons/5/5e/Mitsui_Outlet_Park_Kitahiroshima.jpg','Wikimedia'],null,null,null,null,null]}],
    dining:[]
  },
  {id:7,icon:'fatcat',color:'c7',zh:'Day 7 家庭休閒／貓貓日',en:'Family & Cats',place:{lat:43.0618,lon:141.3545},
    sights:[{id:'catcafe',zh:'貓咖啡（示例）',en:'Cat Café',map:'https://maps.google.com/?q=Cat+Cafe+Sapporo',parking:['https://www.google.com/maps/search/parking+Sapporo+Cat+Cafe'],imgs:[
      ['https://upload.wikimedia.org/wikipedia/commons/7/71/Cat_cafe_interior.jpg','Wikimedia'],null,null,null,null,null]}],
    dining:[]
  },
  {id:8,icon:'onsen',color:'c8',zh:'Day 8 登別溫泉區',en:'Noboribetsu Onsen',place:{lat:42.4124,lon:141.1069},
    sights:[{id:'jigoku',zh:'地獄谷',en:'Jigokudani',map:'https://maps.google.com/?q=Noboribetsu+Jigokudani',parking:['https://www.google.com/maps/search/parking+Jigokudani+Noboribetsu'],imgs:[
      ['https://upload.wikimedia.org/wikipedia/commons/1/1a/Noboribetsu_Jigokudani.jpg','Wikimedia'],
      ['https://upload.wikimedia.org/wikipedia/commons/9/9e/Noboribetsu_Hell_Valley_in_winter.jpg','Wikimedia'],null,null,null,null]}],
    dining:[]
  },
  {id:9,icon:'plane',color:'c9',zh:'Day 9 返程',en:'Fly Home',place:{lat:42.7752,lon:141.6923},sights:[],dining:[]}
];

function qs(s,root=document){return root.querySelector(s)}; function ce(tag){return document.createElement(tag)};

/* Build stickers */
function buildStickers(){
  const wrap=qs('#stickers'); wrap.innerHTML='';
  DAYS.forEach(d=>{
    const a=ce('a'); a.href='#day'+d.id; a.className='sticker';
    const plate=ce('div'); plate.className='plate '+d.color; plate.innerHTML=ICONS[d.icon];
    const label=ce('div'); label.className='label'; label.textContent=d.zh;
    a.appendChild(plate); a.appendChild(label); wrap.appendChild(a);
  });
}

/* Build day sections */
function buildSections(){
  const wrap=qs('#sections'); wrap.innerHTML='';
  DAYS.forEach(d=>{
    const sec=ce('section'); sec.className='section'; sec.id='day'+d.id;
    const back=ce('a'); back.className='back'; back.href='#home'; back.textContent='← 返回首頁';
    const hero=ce('div'); hero.className='hero'; const inner=ce('div'); inner.className='inner';
    const h2=ce('h2'); h2.textContent=d.zh; inner.appendChild(h2);

    const wx=ce('div'); wx.className='wx';
    wx.innerHTML=`<div class="t">${d.zh.split(' ')[0]} 天氣（Day ${d.id}）</div>
    <small id="wx-${d.id}-date">—</small>
    <div class="item"><b>狀況</b><div class="v" id="w${d.id}-cond">—</div></div>
    <div class="item"><b>最高/最低</b><div class="v"><span id="w${d.id}-tmax">—</span>/<span id="w${d.id}-tmin">—</span> °C</div></div>
    <div class="item"><b>降水</b><div class="v" id="w${d.id}-pop">—%</div></div>
    <div class="item"><b>風</b><div class="v"><span id="w${d.id}-wspd">—</span> km/h · <span id="w${d.id}-wdir">—</span></div></div>`;
    inner.appendChild(wx);

    const row=ce('div'); row.className='row';
    const c1=ce('div'); c1.className='card';
    const h21=ce('h2'); h21.textContent='景點與停車'; c1.appendChild(h21);
    const ul=ce('ul'); ul.className='kv';
    d.sights.forEach(s=>{
      const li=ce('li');
      const aMap=ce('a'); aMap.target='_blank'; aMap.href=s.map; aMap.textContent=s.zh; li.appendChild(aMap);
      s.parking.forEach((p,i)=>{ const sep=document.createTextNode(' · '); li.appendChild(sep); const a=ce('a'); a.target='_blank'; a.href=p; a.textContent='停車'+(s.parking.length>1?(' '+(i+1)):''); li.appendChild(a); });
      const sep2=document.createTextNode(' · '); li.appendChild(sep2);
      const aGal=ce('a'); aGal.href='#spot/'+s.id; aGal.textContent='📷 圖集'; li.appendChild(aGal);
      const thumbs=(s.imgs||[]).filter(Boolean).slice(0,2);
      thumbs.forEach(ti=>{ const timg=ce('img'); timg.className='thumb'; timg.src=ti[0]; timg.alt=s.zh; const link=ce('a'); link.href='#spot/'+s.id; link.appendChild(timg); li.appendChild(link); });
      ul.appendChild(li);
    });
    c1.appendChild(ul);

    const c2=ce('div'); c2.className='card';
    const h22=ce('h2'); h22.textContent='餐廳地圖'; c2.appendChild(h22);
    const ul2=ce('ul'); ul2.className='kv'; (d.dining||[]).forEach(r=>{ const li=ce('li'); const a=ce('a'); a.target='_blank'; a.href=r.map; a.textContent=r.zh; li.appendChild(a); ul2.appendChild(li); });
    c2.appendChild(ul2);

    row.appendChild(c1); row.appendChild(c2);
    inner.appendChild(row); hero.appendChild(inner);
    sec.appendChild(back); sec.appendChild(hero); wrap.appendChild(sec);
  });
}

/* Spot galleries */
function buildSpotPages(){
  const container=document.body;
  DAYS.forEach(d=>d.sights.forEach(s=>{
    const sec=ce('section'); sec.className='section'; sec.id='spot-'+s.id;
    const back=ce('a'); back.className='back'; back.href='#day'+d.id; back.textContent='← 返回 Day '+d.id;
    const hero=ce('div'); hero.className='hero'; const inner=ce('div'); inner.className='inner';
    const h2=ce('h2'); h2.textContent=s.zh+' · 固定圖集';
    const gal=ce('div'); gal.className='gallery';
    (s.imgs||[]).forEach((it,ix)=>{
      if(it&&it[0]){ const fig=ce('figure'); const img=ce('img'); img.src=it[0]; img.alt=s.zh; const cap=ce('figcaption'); cap.textContent=it[1]||''; fig.appendChild(img); fig.appendChild(cap); gal.appendChild(fig); }
      else{ const fig=ce('figure'); fig.className='placeholder'; const d=document.createElement('div'); d.textContent='待補 '+(ix+1); fig.appendChild(d); gal.appendChild(fig); }
    });
    inner.appendChild(h2); inner.appendChild(gal); hero.appendChild(inner);
    sec.appendChild(back); container.appendChild(sec);
  }));
}

/* Weather minimal (Open-Meteo) */
function dirText(deg){const zh=['北','北北東','北東','東北東','東','東南東','南東','南南東','南','南南西','南西','西南西','西','西北西','北西','北北西']; const ix=Math.round(deg/22.5)%16; return zh[ix];}
function fmt(n){return (n==null||Number.isNaN(n))?'—':Math.round(n)}
async function fetchDay(lat,lon,date){const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max,wind_direction_10m_dominant&timezone=Asia%2FTokyo&start_date=${date}&end_date=${date}`; const r=await fetch(url); const j=await r.json(); const i=0; return {code:j.daily.weather_code[i],tmax:j.daily.temperature_2m_max[i],tmin:j.daily.temperature_2m_min[i],pop:j.daily.precipitation_probability_max[i],wspd:j.daily.wind_speed_10m_max[i],wdir:j.daily.wind_direction_10m_dominant?.[i]}}
const WMO_ZH={0:'晴',1:'多雲(少)',2:'多雲(間歇)',3:'陰',45:'霧',48:'霧凍',51:'毛毛雨(輕)',53:'毛毛雨(中)',55:'毛毛雨(強)',56:'冰毛毛雨(輕)',57:'冰毛毛雨(強)',61:'小雨',63:'中雨',65:'大雨',66:'凍雨(輕)',67:'凍雨(強)',71:'小雪',73:'中雪',75:'大雪',77:'雪粒',80:'陣雨(輕)',81:'陣雨(中)',82:'陣雨(強)',85:'陣雪(輕)',86:'陣雪(強)',95:'雷雨',96:'雷雨(小冰雹)',99:'雷雨(大冰雹)'};
function getDates(){const t=new Date(); const y=t.getFullYear(),m=('0'+(t.getMonth()+1)).slice(-2),d=('0'+t.getDate()).slice(-2); const start=`${y}-${m}-${d}`; const dates=[]; for(let i=0;i<9;i++){const dt=new Date(start); dt.setDate(new Date(start).getDate()+i); dates.push(dt.toISOString().slice(0,10));} return dates;}
async function loadWeather(){const dates=getDates(); document.getElementById('wx-home-date').textContent=dates[0];
  // home (札幌)
  try{const d=await fetchDay(43.0618,141.3545,dates[0]); document.getElementById('wh-cond').textContent=WMO_ZH[d.code]||d.code; document.getElementById('wh-tmax').textContent=fmt(d.tmax); document.getElementById('wh-tmin').textContent=fmt(d.tmin); document.getElementById('wh-pop').textContent=(d.pop??'—')+'%'; document.getElementById('wh-wspd').textContent=fmt(d.wspd); document.getElementById('wh-wdir').textContent=d.wdir!=null?dirText(d.wdir):'—'; }catch(e){ document.getElementById('wh-cond').textContent='無法取得'; }
  // per-day
  for(const day of DAYS){ const boxDate=document.getElementById(`wx-${day.id}-date`); if(!boxDate) continue; boxDate.textContent=dates[day.id-1]; try{const d=await fetchDay(day.place.lat,day.place.lon,dates[day.id-1]); document.getElementById(`w${day.id}-cond`).textContent=WMO_ZH[d.code]||d.code; document.getElementById(`w${day.id}-tmax`).textContent=fmt(d.tmax); document.getElementById(`w${day.id}-tmin`).textContent=fmt(d.tmin); document.getElementById(`w${day.id}-pop`).textContent=(d.pop??'—')+'%'; document.getElementById(`w${day.id}-wspd`).textContent=fmt(d.wspd); document.getElementById(`w${day.id}-wdir`).textContent=d.wdir!=null?dirText(d.wdir):'—'; }catch(e){ document.getElementById(`w${day.id}-cond`).textContent='無法取得'; } }
}

/* Router */
function updateMode(){const hash=location.hash||'#home'; if(hash==='#home'||hash==='#'||hash===''){ showOnly(null); } else if(hash.startsWith('#day')){ showOnly(hash.substring(1)); } else if(hash.startsWith('#spot/')){ const sid=hash.split('/')[1]; showOnly('spot-'+sid); } }
function showOnly(id){ const secs=[...document.querySelectorAll('.section')]; secs.forEach(s=>{ s.style.display = (!id && s.id) ? 'none' : (s.id===id?'block':'none'); }); if(!id){ qs('#stickers').style.display='grid'; } else { qs('#stickers').style.display='none'; } }
window.addEventListener('hashchange',updateMode);

/* BGM */
let audioCtx=null, master=null, isOn=false;
function startBgm(){ if(isOn) return; if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); master=audioCtx.createGain(); master.gain.value=0.08; master.connect(audioCtx.destination); } const notes=[261.63,329.63,392.00]; notes.forEach((f,i)=>{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(master); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.18,audioCtx.currentTime+2+i*0.2); g.gain.linearRampToValueAtTime(0.12,audioCtx.currentTime+6+i*0.2); g.gain.linearRampToValueAtTime(0.0,audioCtx.currentTime+14+i*0.2); o.start(); setTimeout(()=>o.stop(),16000); }); isOn=true; setTimeout(()=>{isOn=false; startBgm();},16000); }
function stopBgm(){ if(audioCtx){ audioCtx.suspend(); } isOn=false; }
document.getElementById('bgm-toggle').addEventListener('click',()=>{ if(!audioCtx||audioCtx.state==='suspended'){ if(audioCtx) audioCtx.resume(); startBgm(); document.getElementById('bgm-toggle').textContent='🎵 背景音樂：開'; } else { stopBgm(); document.getElementById('bgm-toggle').textContent='🎵 背景音樂：關'; } });
document.getElementById('snow-toggle').addEventListener('click',()=>{ const s=qs('#snow'); s.classList.toggle('on'); document.getElementById('snow-toggle').textContent = s.classList.contains('on')?'❄️ 飄雪：開':'❄️ 飄雪：關'; });

/* Init */
function init(){ buildStickers(); buildSections(); buildSpotPages(); updateMode(); loadWeather(); qs('#snow').classList.add('on'); }
init();
</script>
</body>
</html>
